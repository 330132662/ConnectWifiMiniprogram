var dzBLE = require('./DzBLE.js');
// var bitmapPackage = require('./BitmapPackage.js');
var bitmapPackage = require('./BitmapPackage_Plus.js');
var barcodeWriter = require('./BarcodeWriter.js');
const { currentPrinterInfo } = require('./DzBLE.js');

var _0x1acc=['draw','name','substring','width','DPI','services','deviceId','length','canvasGetImageData','indexOf','exports','fillText','log','RSSI','save','sort','data','没有发现打印机','translate','setFillStyle','white','path','getBLEDeviceServices','setLineWidth','fillRect','toUpperCase','setCurrentPrinterInfoProperty','标签宽度：','restore','connectPeripheral','rotate'];var _0x59e0=function(_0x1acc34,_0x59e09b){_0x1acc34=_0x1acc34-0x0;var _0x3982d0=_0x1acc[_0x1acc34];return _0x3982d0;};var printWidth=0x0;var printHeight=0x0;var printOrientation=0x0;var itemOrientation=0x0;var itemHorizontalAlignment=0x0;var itemVerticalAlignment=0x0;var printPageGapType=-0x1;var printPageGapLength=0x2;var printDarkness=0x0;var printSpeed=0x0;var canvas=null;var canvasJS=null;var isConnecting=![];function covert(_0xe770bc){_0xe770bc=_0xe770bc*DPI()/25.4;_0xe770bc=_0xe770bc>=0x0?_0xe770bc+0.1:_0xe770bc-0.1;return parseInt(_0xe770bc);}function DPI(){var _0x3b0661=currentPrinterInfo()['DPI'];return _0x3b0661;}function setPrintPageGapType(_0x1cd835){printPageGapType=_0x1cd835;}function setPrintPageGapLength(_0x3dcd7a){printPageGapLength=_0x3dcd7a;}function setPrintDarkness(_0x49ca7f){printDarkness=_0x49ca7f;}function setPrintSpeed(_0x35495b){printSpeed=_0x35495b;}function setSupportPrefixs(_0x12f65a){dzBLE['setSupportPrefixs'](_0x12f65a);}function connectingPrinterName(){return currentPrinterInfo()['name'];}function scanedPrinters(_0x4a2543){dzBLE['startScanPeripherals'](function(_0x4cdd56){if(_0x4a2543){_0x4a2543(_0x4cdd56);}});}function compare(_0x26fcb5){return function(_0x7aff6b,_0x5aa200){var _0x3dbe34=_0x7aff6b[_0x26fcb5];var _0x32ddd8=_0x5aa200[_0x26fcb5];return _0x32ddd8-_0x3dbe34;};}function openPrinter(_0x460a38,_0x3fa71f,_0x35f537){wx[_0x59e0('0x16')]({'deviceId':dzBLE['currentConnectedDeviceId'](),'success':function(_0x22d1e8){isConnecting=!![];if(_0x22d1e8){if(_0x22d1e8[_0x59e0('0x6')]==null&&(_0x22d1e8['services']==null||_0x22d1e8[_0x59e0('0x5')]['length']==0x0)){isConnecting=![];}}},'fail':function(_0x1b3e8d){isConnecting=![];},'complete':function(_0x41ca6b){if(isConnecting){if(_0x3fa71f){_0x3fa71f(dzBLE['currentConnectedDeviceId']());}return;}scanedPrinters(function(_0xf0243){var _0x5207b5=null;var _0x3fb353=null;if(_0xf0243[_0x59e0('0x7')]>0x0){if(_0x460a38&&_0x460a38['length']>0x0){for(var _0x3ca902=0x0;_0x3ca902<_0xf0243['length'];_0x3ca902++){var _0x2a7361=_0xf0243[_0x3ca902];var _0x7abd20=_0x2a7361['name'][_0x59e0('0x2')](0x0,_0x460a38['length']);if(_0x7abd20[_0x59e0('0x19')]()[_0x59e0('0x9')](_0x460a38[_0x59e0('0x19')]())>=0x0){_0x5207b5=_0x2a7361[_0x59e0('0x6')];_0x3fb353=_0x2a7361['name'];break;}}}if(_0x460a38==null||_0x460a38['length']==0x0){_0xf0243[_0x59e0('0xf')](compare(_0x59e0('0xd')));_0x5207b5=_0xf0243[0x0]['deviceId'];_0x3fb353=_0xf0243[0x0]['name'];}}if(_0x5207b5==null||_0x5207b5[_0x59e0('0x7')]==0x0){console[_0x59e0('0xc')](_0x59e0('0x11'));dzBLE['setCurrentPrinterInfoProperty'](_0x59e0('0x1'),'');if(_0x35f537){_0x35f537();}}else{dzBLE[_0x59e0('0x1a')](_0x59e0('0x1'),_0x3fb353);dzBLE[_0x59e0('0x1d')](_0x5207b5,function(){if(_0x3fa71f){_0x3fa71f(_0x5207b5);}},function(){dzBLE['setCurrentPrinterInfoProperty']('name','');if(_0x35f537){_0x35f537();}});}});}});}function connectingPrinterDetailInfos(){return dzBLE['currentPrinterInfo']();}function closePrinter(){dzBLE['disconnectPeripheral']();}function startDrawLabel(_0x1802b8,_0x278d6d,_0x3a34ab,_0x3b6554,_0x55703c){canvas=wx['createCanvasContext'](_0x1802b8,_0x278d6d);if(canvas==null){}else{printOrientation=_0x55703c;printWidth=covert(_0x3a34ab);printHeight=covert(_0x3b6554);itemOrientation=0x0;itemHorizontalAlignment=0x0;itemVerticalAlignment=0x0;canvasJS=_0x278d6d;canvas['clearRect'](0x0,0x0,canvas['width'],canvas['height']);canvas[_0x59e0('0x0')]();if(canvasJS['setData']){canvasJS['setData']({'canvasWidth':printWidth,'canvasHeight':printHeight});}else{canvasJS['canvasWidth']=printWidth;canvasJS['canvasHeight']=printHeight;}canvas['setFillStyle'](_0x59e0('0x14'));canvas[_0x59e0('0x18')](0x0,0x0,printWidth+0x5,printHeight+0x5);canvas[_0x59e0('0x13')]('black');}}function endDrawLabel(_0x22df5e){canvas['draw'](!![],setTimeout(function(){if(_0x22df5e){_0x22df5e();}},0x64));}function print(_0x3ed718){wx[_0x59e0('0x8')]({'canvasId':canvas['canvasId'],'x':0x0,'y':0x0,'width':printWidth,'height':printHeight,'success'(_0x2da8e8){var _0x4866e6=[];var _0x567e52=_0x2da8e8[_0x59e0('0x3')];var _0x31294e=_0x2da8e8['height'];if(printOrientation==0x0){_0x4866e6=_0x2da8e8[_0x59e0('0x10')];}else if(printOrientation==0x5a){for(var _0x147645=0x0;_0x147645<_0x567e52;_0x147645++){for(var _0x38d0eb=0x0;_0x38d0eb<_0x31294e;_0x38d0eb++){var _0x296be4=(_0x147645*_0x31294e+_0x38d0eb)*0x4;var _0x1f3ac6=((_0x31294e-0x1-_0x38d0eb)*_0x567e52+_0x147645)*0x4;_0x4866e6[_0x296be4+0x0]=_0x2da8e8['data'][_0x1f3ac6+0x0];_0x4866e6[_0x296be4+0x1]=_0x2da8e8['data'][_0x1f3ac6+0x1];_0x4866e6[_0x296be4+0x2]=_0x2da8e8['data'][_0x1f3ac6+0x2];_0x4866e6[_0x296be4+0x3]=_0x2da8e8['data'][_0x1f3ac6+0x3];}}var _0x1eac91=_0x567e52;_0x567e52=_0x31294e;_0x31294e=_0x1eac91;}else if(printOrientation==0xb4){for(var _0x38d0eb=0x0;_0x38d0eb<_0x31294e;_0x38d0eb++){for(var _0x147645=0x0;_0x147645<_0x567e52;_0x147645++){var _0x296be4=(_0x38d0eb*_0x567e52+_0x147645)*0x4;var _0x1f3ac6=((_0x31294e-0x1-_0x38d0eb)*_0x567e52+_0x567e52-0x1-_0x147645)*0x4;_0x4866e6[_0x296be4+0x0]=_0x2da8e8[_0x59e0('0x10')][_0x1f3ac6+0x0];_0x4866e6[_0x296be4+0x1]=_0x2da8e8['data'][_0x1f3ac6+0x1];_0x4866e6[_0x296be4+0x2]=_0x2da8e8['data'][_0x1f3ac6+0x2];_0x4866e6[_0x296be4+0x3]=_0x2da8e8[_0x59e0('0x10')][_0x1f3ac6+0x3];}}}else if(printOrientation==0x10e){for(var _0x147645=0x0;_0x147645<_0x567e52;_0x147645++){for(var _0x38d0eb=0x0;_0x38d0eb<_0x31294e;_0x38d0eb++){var _0x296be4=(_0x147645*_0x31294e+_0x38d0eb)*0x4;var _0x1f3ac6=(_0x38d0eb*_0x567e52+_0x567e52-0x1-_0x147645)*0x4;_0x4866e6[_0x296be4+0x0]=_0x2da8e8['data'][_0x1f3ac6+0x0];_0x4866e6[_0x296be4+0x1]=_0x2da8e8['data'][_0x1f3ac6+0x1];_0x4866e6[_0x296be4+0x2]=_0x2da8e8['data'][_0x1f3ac6+0x2];_0x4866e6[_0x296be4+0x3]=_0x2da8e8['data'][_0x1f3ac6+0x3];}}var _0x1eac91=_0x567e52;_0x567e52=_0x31294e;_0x31294e=_0x1eac91;}console['log'](_0x59e0('0x1b')+_0x567e52);console['log']('标签高度：'+_0x31294e);var _0x369d23=bitmapPackage['arrayWithImage'](_0x4866e6,currentPrinterInfo()[_0x59e0('0x4')],currentPrinterInfo()[_0x59e0('0x3')],_0x567e52,_0x31294e,printPageGapType,printPageGapLength*0x64,printDarkness,printSpeed);dzBLE['sendData'](_0x369d23,function(){if(_0x3ed718){_0x3ed718();}});}},canvasJS);}function setItemOrientation(_0x23d590){if(_0x23d590!=0x0&&_0x23d590!=0x5a&&_0x23d590!=0xb4&&_0x23d590!=0x10e){return;}itemOrientation=_0x23d590;}function setItemHorizontalAlignment(_0x1a9779){if(_0x1a9779!=0x0&&_0x1a9779!=0x1&&_0x1a9779!=0x2){return;}itemHorizontalAlignment=_0x1a9779;}function setItemVerticalAlignment(_0x361c0b){if(_0x361c0b!=0x0&&_0x361c0b!=0x1&&_0x361c0b!=0x2){return;}itemVerticalAlignment=_0x361c0b;}function drawTextInWidth(_0x524d32,_0x296c5a,_0x296b54,_0x1be2fd,_0x2f05be){var _0x586ef3=covert(_0x296c5a);var _0x4ddf72=covert(_0x296b54);var _0x5b80d8=covert(_0x1be2fd);canvas['setFontSize'](covert(_0x2f05be));const _0x441a1c=canvas['measureText'](_0x524d32)[_0x59e0('0x3')];switch(itemHorizontalAlignment){case 0x0:{break;}case 0x1:{_0x586ef3+=(_0x5b80d8-_0x441a1c)*0.5;break;}case 0x2:{_0x586ef3+=_0x5b80d8-_0x441a1c;break;}default:break;}canvas[_0x59e0('0xb')](_0x524d32,_0x586ef3,_0x4ddf72);}function drawText(_0x19f14c,_0x46f6cf,_0xdf895f,_0x3ed91c){setItemHorizontalAlignment(0x0);drawTextInWidth(_0x19f14c,_0x46f6cf,_0xdf895f,printWidth,_0x3ed91c);}function drawBarcode(_0x1c347a,_0x386b64,_0x334044,_0x17f36f,_0x39b312){_0x386b64=covert(_0x386b64);_0x334044=covert(_0x334044);_0x17f36f=covert(_0x17f36f);_0x39b312=covert(_0x39b312);canvas[_0x59e0('0xe')]();switch(itemOrientation){case 0x1:case 0x5a:{canvas[_0x59e0('0x1e')](Math['PI']/0x2);canvas['translate'](parseInt(_0x334044-_0x386b64),parseInt(-_0x386b64-_0x334044-_0x17f36f));var _0x1a1cc2=_0x17f36f;_0x17f36f=_0x39b312;_0x39b312=_0x1a1cc2;break;}case 0x2:case 0xb4:{canvas['rotate'](Math['PI']);canvas['translate'](parseInt(-_0x386b64*0x2-_0x17f36f),parseInt(-_0x334044*0x2-_0x39b312));break;}case 0x3:case 0x10e:{canvas['rotate'](-Math['PI']/0x2);canvas[_0x59e0('0x12')](parseInt(-_0x386b64-_0x334044-_0x39b312),parseInt(_0x386b64-_0x334044));var _0x1a1cc2=_0x17f36f;_0x17f36f=_0x39b312;_0x39b312=_0x1a1cc2;break;}default:break;}barcodeWriter['barcode'](canvas,_0x1c347a,_0x386b64,_0x334044,_0x17f36f,_0x39b312);canvas['restore']();}function drawQRCode(_0x443d9b,_0x45097b,_0x517762,_0xb03430,_0x4915ab,_0x503bb1){_0x45097b=covert(_0x45097b);_0x517762=covert(_0x517762);_0xb03430=covert(_0xb03430);_0x4915ab=covert(_0x4915ab);canvas['save']();switch(itemOrientation){case 0x1:case 0x5a:{canvas[_0x59e0('0x1e')](Math['PI']/0x2);canvas[_0x59e0('0x12')](parseInt(_0x517762-_0x45097b),parseInt(-_0x45097b-_0x517762-_0xb03430));var _0x39fdd6=_0xb03430;_0xb03430=_0x4915ab;_0x4915ab=_0x39fdd6;break;}case 0x2:case 0xb4:{canvas[_0x59e0('0x1e')](Math['PI']);canvas['translate'](parseInt(-_0x45097b*0x2-_0xb03430),parseInt(-_0x517762*0x2-_0x4915ab));break;}case 0x3:case 0x10e:{canvas['rotate'](-Math['PI']/0x2);canvas[_0x59e0('0x12')](parseInt(-_0x45097b-_0x517762-_0x4915ab),parseInt(_0x45097b-_0x517762));var _0x39fdd6=_0xb03430;_0xb03430=_0x4915ab;_0x4915ab=_0x39fdd6;break;}default:break;}barcodeWriter['qrcode'](canvas,_0x443d9b,_0x45097b,_0x517762,_0xb03430,_0x4915ab,_0x503bb1);canvas['restore']();}function drawLine(_0x4ee4e0,_0x364848,_0x1e6cac,_0x3d5a6a){drawRectangle(_0x4ee4e0,_0x364848,_0x1e6cac,_0x3d5a6a,0x0,!![]);}function drawRectangle(_0x4291b7,_0x1579ef,_0xfb0ae3,_0x76f5a2,_0x22c08e,_0xe7520b){_0x4291b7=covert(_0x4291b7);_0x1579ef=covert(_0x1579ef);_0xfb0ae3=covert(_0xfb0ae3);_0x76f5a2=covert(_0x76f5a2);_0x22c08e=covert(_0x22c08e);canvas['save']();switch(itemOrientation){case 0x1:case 0x5a:{canvas[_0x59e0('0x1e')](Math['PI']/0x2);canvas[_0x59e0('0x12')](parseInt(_0x1579ef-_0x4291b7),parseInt(-_0x4291b7-_0x1579ef-_0xfb0ae3));var _0x301b56=_0xfb0ae3;_0xfb0ae3=_0x76f5a2;_0x76f5a2=_0x301b56;break;}case 0x2:case 0xb4:{canvas['rotate'](Math['PI']);canvas[_0x59e0('0x12')](parseInt(-_0x4291b7*0x2-_0xfb0ae3),parseInt(-_0x1579ef*0x2-_0x76f5a2));break;}case 0x3:case 0x10e:{canvas[_0x59e0('0x1e')](-Math['PI']/0x2);canvas[_0x59e0('0x12')](parseInt(-_0x4291b7-_0x1579ef-_0x76f5a2),parseInt(_0x4291b7-_0x1579ef));var _0x301b56=_0xfb0ae3;_0xfb0ae3=_0x76f5a2;_0x76f5a2=_0x301b56;break;}default:break;}canvas[_0x59e0('0x17')](_0x22c08e);if(_0xe7520b){canvas[_0x59e0('0x13')]('black');canvas['fillRect'](_0x4291b7,_0x1579ef,_0xfb0ae3,_0x76f5a2);}else{canvas['strokeRect'](_0x4291b7,_0x1579ef,_0xfb0ae3,_0x76f5a2);}canvas['restore']();}function drawImage(_0x4a3f5f,_0x35d904,_0x47bdd8,_0x5e28ae,_0x2729dd){_0x35d904=covert(_0x35d904);_0x47bdd8=covert(_0x47bdd8);_0x5e28ae=covert(_0x5e28ae);_0x2729dd=covert(_0x2729dd);canvas['save']();switch(itemOrientation){case 0x1:case 0x5a:{canvas[_0x59e0('0x1e')](Math['PI']/0x2);canvas['translate'](parseInt(_0x47bdd8-_0x35d904),parseInt(-_0x35d904-_0x47bdd8-_0x5e28ae));var _0x221a30=_0x5e28ae;_0x5e28ae=_0x2729dd;_0x2729dd=_0x221a30;break;}case 0x2:case 0xb4:{canvas['rotate'](Math['PI']);canvas[_0x59e0('0x12')](parseInt(-_0x35d904*0x2-_0x5e28ae),parseInt(-_0x47bdd8*0x2-_0x2729dd));break;}case 0x3:case 0x10e:{canvas[_0x59e0('0x1e')](-Math['PI']/0x2);canvas['translate'](parseInt(-_0x35d904-_0x47bdd8-_0x2729dd),parseInt(_0x35d904-_0x47bdd8));var _0x221a30=_0x5e28ae;_0x5e28ae=_0x2729dd;_0x2729dd=_0x221a30;break;}default:break;}canvas['drawImage'](_0x4a3f5f,_0x35d904,_0x47bdd8,_0x5e28ae,_0x2729dd);canvas[_0x59e0('0x1c')]();}function drawImageURL(_0xc6a649,_0x9a69e3,_0x39f1fb,_0x4621ed,_0x5d6174,_0x45e4e3){_0x9a69e3=covert(_0x9a69e3);_0x39f1fb=covert(_0x39f1fb);_0x4621ed=covert(_0x4621ed);_0x5d6174=covert(_0x5d6174);canvas[_0x59e0('0xe')]();switch(itemOrientation){case 0x1:case 0x5a:{canvas[_0x59e0('0x1e')](Math['PI']/0x2);canvas[_0x59e0('0x12')](parseInt(_0x39f1fb-_0x9a69e3),parseInt(-_0x9a69e3-_0x39f1fb-_0x4621ed));var _0x19cc7e=_0x4621ed;_0x4621ed=_0x5d6174;_0x5d6174=_0x19cc7e;break;}case 0x2:case 0xb4:{canvas['rotate'](Math['PI']);canvas[_0x59e0('0x12')](parseInt(-_0x9a69e3*0x2-_0x4621ed),parseInt(-_0x39f1fb*0x2-_0x5d6174));break;}case 0x3:case 0x10e:{canvas[_0x59e0('0x1e')](-Math['PI']/0x2);canvas[_0x59e0('0x12')](parseInt(-_0x9a69e3-_0x39f1fb-_0x5d6174),parseInt(_0x9a69e3-_0x39f1fb));var _0x19cc7e=_0x4621ed;_0x4621ed=_0x5d6174;_0x5d6174=_0x19cc7e;break;}default:break;}wx['getImageInfo']({'src':_0xc6a649,'success':function(_0x45798b){canvas['drawImage'](_0x45798b[_0x59e0('0x15')],_0x9a69e3,_0x39f1fb,_0x4621ed,_0x5d6174);canvas['restore']();if(_0x45e4e3){_0x45e4e3(!![]);}},'fail':function(_0x3302b5){canvas[_0x59e0('0x1c')]();if(_0x45e4e3){_0x45e4e3(![]);}}});}module[_0x59e0('0xa')]={'setPrintPageGapType':setPrintPageGapType,'setPrintPageGapLength':setPrintPageGapLength,'setPrintDarkness':setPrintDarkness,'setPrintSpeed':setPrintSpeed,'setSupportPrefixs':setSupportPrefixs,'connectingPrinterName':connectingPrinterName,'scanedPrinters':scanedPrinters,'openPrinter':openPrinter,'connectingPrinterDetailInfos':connectingPrinterDetailInfos,'closePrinter':closePrinter,'startDrawLabel':startDrawLabel,'endDrawLabel':endDrawLabel,'print':print,'setItemOrientation':setItemOrientation,'setItemHorizontalAlignment':setItemHorizontalAlignment,'setItemVerticalAlignment':setItemVerticalAlignment,'drawText':drawText,'drawTextInWidth':drawTextInWidth,'drawBarcode':drawBarcode,'drawQRCode':drawQRCode,'drawLine':drawLine,'drawRectangle':drawRectangle,'drawImage':drawImage,'drawImageURL':drawImageURL};